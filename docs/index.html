<!DOCTYPE html>
<html lang="vi" data-theme="auto">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>news crawler ‚Äî @ttqteo</title>
<style>
  :root{
    --bg:#f8fafc; --card:#ffffff; --text:#0f172a; --muted:#475569; --muted-2:#64748b;
    --border:#e2e8f0; --accent:#2563eb; --accent-2:#1d4ed8;
  }
  [data-theme="dark"]{
    --bg:#0b1220; --card:#0f172a; --text:#e2e8f0; --muted:#a3adc2; --muted-2:#94a3b8; --border:#25324a; --accent:#60a5fa; --accent-2:#93c5fd;
  }
  @media (prefers-color-scheme: dark){ [data-theme="auto"]{ --bg:#0b1220; --card:#0f172a; --text:#e2e8f0; --muted:#a3adc2; --muted-2:#94a3b8; --border:#25324a; --accent:#60a5fa; --accent-2:#93c5fd; } }

  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.55 system-ui,Segoe UI,Roboto,Inter,Arial}
  a{color:inherit}
  header{position:sticky;top:0;z-index:20;background:var(--card);border-bottom:1px solid var(--border)}
  .wrap{max-width:1000px;margin:0 auto;padding:10px 14px;display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  select,input,button{padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:transparent;color:var(--text)}
  button.primary{background:var(--accent);color:#fff;border:0;cursor:pointer}
  button.ghost{border-color:var(--border);cursor:pointer}

  main{max-width:1000px;margin:12px auto;padding:0 14px}

  /* RICH MODE (image + summary) */
  .card{display:grid;grid-template-columns:repeat(10,1fr);gap:12px;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px;margin-bottom:10px}
  .thumb-wrap{grid-column:span 2}
  .thumb{width:100%;aspect-ratio:16/10;object-fit:cover;border-radius:8px;background:#e2e8f0}
  .content{grid-column:span 8;display:flex;flex-direction:column;min-width:0}
  .content.full{grid-column:1/-1}
  .title{margin:0;font-weight:750;font-size:12px;line-height:auto;}
  .title a{text-decoration:none}
  .title a:hover{color:var(--accent-2);text-decoration:underline}
  .summary{margin:0 0 6px 0;color:var(--muted)}
  .summary.clamp{display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
  .meta{margin-top:auto;display:flex;gap:8px;justify-content:space-between;color:var(--muted-2);font-size:.86rem;border-top:1px solid var(--border);padding-top:6px}

  /* COMPACT MODE (time | title | tags | source) */
  .row{display:grid;grid-template-columns:110px 1fr auto 160px;gap:8px;align-items:center;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px;margin-bottom:8px}
  .row .time{color:var(--muted-2);font-variant-numeric:tabular-nums;font-size:10px;line-height:auto;}
  .row .title a{color:var(--text);text-decoration:none}
  .row .title a:hover{color:var(--accent-2);text-decoration:underline}
  .row .tags{display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-start}
  /* allow wrapping container that doesn't affect desktop grid placement */
  .row .meta{display:contents}
  .tag{border:1px solid var(--border);padding:2px 6px;border-radius:999px;font-size:.72rem;color:#1e40af;background:#eef2ff;white-space:nowrap}
  .row .source{color:var(--muted-2);text-align:right;font-size:10px;}
  .row:hover{border-color:var(--accent)}

  /* Date separator when viewing all dates */
  .date-sep{margin:16px 2px 10px 2px;color:var(--muted-2);font-weight:700;border-left:3px solid var(--border);padding-left:8px}

  /* Popover for summary in compact */
  .popover{position:absolute;z-index:50;max-width:560px;background:var(--card);color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px 12px;box-shadow:0 8px 30px rgba(0,0,0,.15);pointer-events:none;opacity:0;transform:translateY(4px);transition:opacity .12s ease, transform .12s ease}
  .popover.show{opacity:1;transform:translateY(0)}

  /* Mobile */
  @media (max-width:640px){
    .card{grid-template-columns:1fr}
    .thumb-wrap{grid-column:1/-1}
    .content,.content.full{grid-column:1/-1}
    /* Compact rows on mobile: time | title, then meta bottom-right */
    .row{grid-template-columns:90px 1fr; align-items:start}
    .row .time{font-size:11px}
    .row .meta{grid-column:1/-1; display:flex; justify-content:flex-end; gap:10px; align-items:center}
    .row .source{ text-align:right; font-size:11px }
  }
</style>
</head>
<body>
<header>
  <div class="wrap">
    <select id="dateSelect" title="Ch·ªçn ng√†y"></select>
    <button id="btnLatest" class="primary" style="display: none">Tin m·ªõi nh·∫•t</button>
    <input id="searchInput" placeholder="T√¨m ti√™u ƒë·ªÅ/t√≥m t·∫Øt‚Ä¶" style="flex:1" />
    <button id="btnClear" class="ghost" style="display: none">Xo√°</button>
    <select id="viewModeSel" title="Ch·∫ø ƒë·ªô hi·ªÉn th·ªã">
      <option value="rich">Tho·∫£i M√°i</option>
      <option value="compact">G·ªçn</option>
    </select>
    <button id="themeToggle" class="ghost" title="Dark/Light">üåì</button>
  </div>
</header>

<main id="newsList"></main>
<div id="popover" class="popover" aria-hidden="true"></div>

<script>
// Two view modes saved in localStorage: 'rich' (default) and 'compact' (time ‚Üí title ‚Üí tags ‚Üí source, summary on hover)
const dateSelect = document.getElementById('dateSelect');
const btnLatest  = document.getElementById('btnLatest');
const searchInput= document.getElementById('searchInput');
const btnClear   = document.getElementById('btnClear');
const newsList   = document.getElementById('newsList');
const viewModeSel= document.getElementById('viewModeSel');
const themeToggle= document.getElementById('themeToggle');
const popover    = document.getElementById('popover');

const state = {
  items: [],
  view: [],
  symbols: [],
  selectedSources: new Set(JSON.parse(localStorage.getItem('srcSet')||'[]')),
  cluster: localStorage.getItem('cluster') === '1',
  timeWindow: localStorage.getItem('timeWindow') || 'all',
  viewMode: localStorage.getItem('viewMode') || 'rich',
  groupByDate: false,
};
viewModeSel.value = state.viewMode;

// theme
function applyTheme(mode){ document.documentElement.setAttribute('data-theme', mode); }
function getPrefs(){ try{ return JSON.parse(localStorage.getItem('prefs')||'{}'); }catch{return {}} }
function savePrefs(p){ localStorage.setItem('prefs', JSON.stringify(p)); }
const prefs = getPrefs(); applyTheme(prefs.theme||'auto');
function nextTheme(m){ return m==='auto'?'dark': m==='dark'?'light':'auto'; }
function themeEmoji(m){ return m==='auto'?'üåì': m==='dark'?'üåô':'‚òÄÔ∏è'; }
function refreshThemeBtn(){ themeToggle.textContent = themeEmoji(document.documentElement.getAttribute('data-theme')||'auto'); }
refreshThemeBtn();

themeToggle.addEventListener('click', ()=>{
  const cur = document.documentElement.getAttribute('data-theme')||'auto';
  const n = nextTheme(cur); applyTheme(n); refreshThemeBtn(); savePrefs({...prefs, theme:n});
});

// helpers
function debounce(fn,ms){let t;return (...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)};}
async function fetchJSON(url){ const r = await fetch(url,{cache:'no-store'}); if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }
function escapeHTML(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\"/g,'&quot;'); }

// symbols (optional)
async function loadSymbols(){
  try{
    const res = await fetch('assets/symbols.csv');
    const csv = await res.text();
    const lines = csv.split('\n').slice(1);
    state.symbols = lines.map(line=>{ const [symbol] = line.split(','); return symbol; }).filter(Boolean);
  }catch(e){ /* optional */ }
}

// symbols to skip from tagging
const SKIP_SYMBOLS = new Set([
  'TIN',
  'USD',
  'THU',
  'VND',
  'CEO',
  'THA',
  'MTL',
  'NET',
  'TOP',
  'HCM'
]);

function findSymbols(text){
  if(!text || !state.symbols.length) return [];
  const txt = ' '+text+' ';
  const out = [];
  for(const s of state.symbols){ if(s && s.length>=2){ const re = new RegExp('\\b'+s+'\\b','i'); if(re.test(txt)){ const u = s.toUpperCase(); if(!SKIP_SYMBOLS.has(u)) out.push(u); } }}
  return [...new Set(out)].slice(0,8);
}

// clustering utils (optional)
function normalizeTitle(t){ return (t||'').toLowerCase().replace(/[^\p{L}\p{N}\s]/gu,' ').replace(/\s+/g,' ').trim(); }
function titleSim(a,b){ const bg=s=>{const x=normalizeTitle(s);let arr=[];for(let i=0;i<x.length-1;i++) arr.push(x.slice(i,i+2));return arr;}; const A=new Map(),B=new Map(); for(const k of bg(a)) A.set(k,(A.get(k)||0)+1); for(const k of bg(b)) B.set(k,(B.get(k)||0)+1); let inter=0,total=0; for(const [k,v] of A){ if(B.has(k)) inter+=Math.min(v,B.get(k)); total+=v;} for(const [k,v] of B){ total+=v;} return total? (2*inter)/total : 0; }
function clusterByTitle(items, thr=0.62){ const clusters=[]; const used=new Array(items.length).fill(false); for(let i=0;i<items.length;i++){ if(used[i]) continue; used[i]=true; const base=items[i]; const g=[base]; for(let j=i+1;j<items.length;j++){ if(used[j]) continue; if(titleSim(base.title, items[j].title)>=thr){ used[j]=true; g.push(items[j]); } } g.sort((a,b)=>new Date(b.published)-new Date(a.published)); clusters.push(g[0]); } return clusters; }

// infinite scroll
const BATCH=10; let rendered=0; let observer=null; let sentinel=null;
function resetAndRender(){ newsList.innerHTML=''; rendered=0; if(observer){ observer.disconnect(); } observer = new IntersectionObserver((entries)=>{ if(entries.some(e=>e.isIntersecting)){ observer.unobserve(entries[0].target); renderBatch(); } }, {rootMargin:'800px'}); renderBatch(); }
function renderBatch(){ const end=Math.min(rendered+BATCH, state.view.length); const frag=document.createDocumentFragment(); for(let i=rendered;i<end;i++){ frag.appendChild(buildNode(i)); } newsList.appendChild(frag); rendered=end; if(sentinel){ sentinel.remove(); sentinel=null; } if(rendered < state.view.length){ sentinel=document.createElement('div'); sentinel.style.height='1px'; newsList.appendChild(sentinel); observer.observe(sentinel); } }

function dateKeyFromTs(ts){ const d=new Date(ts); const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${dd}`; }
function formatDateLabel(ts){ return new Date(ts).toLocaleDateString('vi-VN'); }
function buildNode(i){ const it = state.view[i]; const frag=document.createDocumentFragment(); if(state.groupByDate){ const curKey = dateKeyFromTs(it.published); const prev = state.view[i-1]; const prevKey = i>0 ? dateKeyFromTs(prev.published) : null; if(i===0 || curKey!==prevKey){ const h=document.createElement('h4'); h.className='date-sep'; h.textContent = formatDateLabel(it.published); frag.appendChild(h); } } const node = state.viewMode==='compact' ? buildRow(it) : buildCard(it); frag.appendChild(node); return frag; }

function buildCard(it){ const hasImg=!!it.image; const card=document.createElement('article'); card.className='card'; const left = hasImg? `<div class="thumb-wrap"><img class="thumb" loading="lazy" decoding="async" src="${it.image}" alt=""></div>` : '' ; const cls = hasImg? 'content' : 'content full'; card.innerHTML = `${left}<div class="${cls}"><h3 class="title"><a href="${it.link}" target="_blank" rel="noopener">${escapeHTML(it.title)}</a></h3><p class="summary clamp">${escapeHTML(it.summary||'')}</p><div class="meta"><span>${escapeHTML(it.source||'Unknown')}</span><span>${new Date(it.published).toLocaleString('vi-VN')}</span></div></div>`; return card; }

function buildRow(it) { 
  const row=document.createElement('div'); 
  row.className='row'; 
  row.setAttribute('data-summary', (it.summary||'').replace(/\n/g,' ')); 
  const tags = findSymbols(it.title + ';' + it.description).map(s=>`<span class="tag">${s}</span>`).join(''); 
  row.innerHTML = `<div class="time">${new Date(it.published).toLocaleString('vi-VN')}</div><div class="title"><a href="${it.link}" target="_blank" rel="noopener">${escapeHTML(it.title)}</a></div><div class="meta"><div class="tags">${tags}</div><div class="source">${escapeHTML(it.source||'Unknown')}</div></div>`; 
  row.addEventListener('mouseenter', ()=> showPopover(row)); 
  row.addEventListener('mouseleave', hidePopover); 
  return row; 
}

function showPopover(target){
  const text = target.getAttribute('data-summary');
  if(!text) return;
  popover.innerText = text;
  const r = target.getBoundingClientRect();
  const rightOffset = (document.documentElement.clientWidth - (r.right + window.scrollX));
  popover.style.left = 'auto';
  popover.style.right = rightOffset + 'px';
  popover.style.top  = (r.bottom + window.scrollY + 3) + 'px';
  popover.classList.add('show');
  popover.setAttribute('aria-hidden','false');
}
function hidePopover(){ popover.classList.remove('show'); popover.setAttribute('aria-hidden','true'); }
window.addEventListener('scroll', ()=>{ if(popover.classList.contains('show')) hidePopover(); }, {passive:true});

function applyFilter(){ const q = searchInput.value.trim().toLowerCase(); let arr = state.items.filter(it=>{ const text=(it.title+' '+(it.summary||'')).toLowerCase(); return !q || text.includes(q); }); if(state.selectedSources.size){ arr = arr.filter(it=> state.selectedSources.has(it.source||'Unknown')); } if(state.timeWindow!=='all'){ const now=Date.now(); const ms = state.timeWindow==='24h'? 24*3600*1000 : state.timeWindow==='3d'? 3*86400*1000 : 7*86400*1000; arr = arr.filter(it => (now - new Date(it.published).getTime()) <= ms); } state.view = state.cluster? clusterByTitle(arr) : arr; state.view.sort((a,b)=> new Date(b.published)-new Date(a.published)); resetAndRender(); }

async function loadIndex(){ await loadSymbols(); const idx = await fetchJSON('news/index.json'); const dates = idx.dates || []; dateSelect.innerHTML=''; const allOption=document.createElement('option'); allOption.value='all'; allOption.textContent='T·∫•t c·∫£'; dateSelect.appendChild(allOption); dates.forEach(d=>{const o=document.createElement('option');o.value=d;o.textContent=d;dateSelect.appendChild(o)}); const udate=new URLSearchParams(location.search).get('date'); dateSelect.value = udate && (udate==='all' || dates.includes(udate)) ? udate : 'all'; await loadDay(dateSelect.value); }

async function loadDay(d){ if(d==='all'){ const idx = await fetchJSON('news/index.json'); const all = await Promise.all(idx.dates.map(dt=> fetchJSON('news/'+dt+'.json'))); state.items = all.flatMap(x=> Object.values(x)); state.groupByDate = true; } else { const data = await fetchJSON('news/'+d+'.json'); state.items = Object.values(data); state.groupByDate = false; } applyFilter(); }

// events
const runFilter = debounce(applyFilter, 120);
searchInput.addEventListener('input', runFilter);
btnClear.addEventListener('click', ()=>{ searchInput.value=''; applyFilter(); searchInput.focus(); });

dateSelect.addEventListener('change', ()=> loadDay(dateSelect.value));
btnLatest.addEventListener('click', async ()=>{ const latest = await fetchJSON('news/latest.json'); if(latest && latest.date){ dateSelect.value = latest.date; await loadDay(latest.date); } });

viewModeSel.addEventListener('change', ()=>{ state.viewMode = viewModeSel.value; localStorage.setItem('viewMode', state.viewMode); resetAndRender(); });

// persist selected view on load
localStorage.setItem('viewMode', state.viewMode);

// boot
loadIndex();
</script>
</body>
</html>
