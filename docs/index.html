<!DOCTYPE html>
<html lang="vi" data-theme="dark">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>News Crawler - Discovery</title>
<link rel="icon" href="assets/images/icon.jpg" type="image/jpeg" />
<link rel="apple-touch-icon" href="assets/images/icon.jpg" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Hanken+Grotesk:wght@400;600;800;900&family=Playfair+Display:wght@700;800&family=Lora:ital,wght@0,400..700;1,400..700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.2/css/all.min.css" />
<style>
  :root {
    --bg: #ffffff;
    --sidebar-bg: #f3f3f3;
    --border: #e5e7eb;
    --text: #111827;
    --text-muted: #6b7280;
    --accent: #2563eb;
    --accent-hover: #1d4ed8;
    --card-bg: #ffffff;
    --hover-bg: #f9fafb;
    --sidebar-width: 240px;
    --right-panel-width: 380px;
    --max-content-width: 1040px;
    --tag-bg: #eef2ff;
    --tag-text: #1e40af;
    --font-serif: 'Lora', 'Playfair Display', serif;
    --font-sans: 'Hanken Grotesk', system-ui, sans-serif;
  }

  [data-theme="dark"] {
    --bg: #000000;
    --sidebar-bg: #000000;
    --border: #262626;
    --text: #ffffff;
    --text-muted: #a3a3a3;
    --accent: #3b82f6;
    --accent-hover: #60a5fa;
    --card-bg: #000000;
    --hover-bg: #111111;
    --tag-bg: rgba(59, 130, 246, 0.15);
    --tag-text: #93c5fd;
  }

  * { box-sizing: border-box; }
  body {
    margin: 0;
    background: var(--bg);
    color: var(--text);
    font-family: var(--font-sans);
    line-height: 1.5;
    display: flex;
    overflow-x: hidden;
  }

  /* SIDEBAR */
  .sidebar {
    width: var(--sidebar-width); height: 100vh; position: fixed; left: 0; top: 0;
    background: var(--sidebar-bg); border-right: 1px solid var(--border); padding: 24px 16px;
    display: flex; flex-direction: column; z-index: 500; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  .sidebar-collapsed .sidebar { transform: translateX(-100%); }
  .sidebar-logo {
    display: flex; align-items: center; gap: 12px; font-weight: 800; font-size: 22px; text-decoration: none; color: var(--text); padding: 0 12px 32px 12px;
  }
  .sidebar-logo img { width: 32px; height: 32px; border-radius: 8px; }
  .side-btn {
    display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 12px; color: var(--text-muted); text-decoration: none; font-weight: 600; font-size: 15px; margin-bottom: 4px; transition: all 0.2s;
  }
  .side-btn i { font-size: 18px; width: 24px; text-align: center; }
  .side-btn:hover, .side-btn.active { color: var(--text); background: var(--hover-bg); }
  .side-btn.active { color: var(--accent); }
  .side-footer { margin-top: auto; padding: 20px 12px; border-top: 1px solid var(--border); }
  .theme-btn {
    display: flex; align-items: center; justify-content: center; gap: 10px; width: 100%; 
    padding: 10px; border-radius: 14px; background: none; border: 1px solid var(--border);
    color: var(--text); font-weight: 700; font-size: 14px; cursor: pointer; transition: all 0.2s;
  }
  .theme-btn:hover { background: var(--hover-bg); border-color: var(--text-muted); }
  .theme-btn i { font-size: 16px; opacity: 0.8; }

  .app-container {
    margin-left: var(--sidebar-width); flex: 1; display: grid; 
    grid-template-columns: 1fr var(--right-panel-width);
    width: calc(100vw - var(--sidebar-width)); min-height: 100vh;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }
  .sidebar-collapsed .app-container { margin-left: 0; width: 100vw; }
  .qv-collapsed .app-container { grid-template-columns: 1fr 0px; }
  .qv-collapsed .quick-view { opacity: 0; pointer-events: none; }

  /* FEED */
  .main-feed { padding: 24px 40px; width: 100%; max-width: var(--max-content-width); margin: 0 auto; }
  header { position: sticky; top: 0; background: var(--bg); z-index: 100; padding: 16px 0; margin-bottom: 40px; }
  .header-actions { display: flex; align-items: center; gap: 16px; margin-bottom: 24px; }
  .btn-toggle { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 20px; padding: 4px; border-radius: 8px; }
  .btn-toggle:hover { background: var(--hover-bg); color: var(--text); }
  .discover-header { font-size: 36px; font-weight: 800; letter-spacing: -0.5px; }
  
  .nav-tabs { display: flex; gap: 8px; overflow-x: auto; scrollbar-width: none; border-bottom: 1px solid var(--border); }
  .nav-tabs::-webkit-scrollbar { display: none; }
  .tab { padding: 12px 16px; font-size: 15px; font-weight: 700; color: var(--text-muted); cursor: pointer; position: relative; white-space: nowrap; margin-right: 8px; transition: color 0.2s; }
  .tab.active { color: var(--text); }
  .tab.active::after { content: ""; position: absolute; bottom: -1px; left: 0; width: 100%; height: 2px; background: var(--text); }

  /* MODERN GRID SYSTEM */
  #newsList { display: flex; flex-direction: column; gap: 40px; }
  .card-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; }
  
  /* BASE CARD */
  .card { 
    display: flex; flex-direction: column; cursor: pointer; 
    border-radius: 16px; position: relative;
  }
  .card:hover .card-title { color: var(--accent); }

  /* HERO CARD */
  .card-hero { flex-direction: row; gap: 40px; align-items: center; }
  .card-hero .card-content { flex: 1.2; }
  .card-hero .card-title { font-family: var(--font-serif); font-size: 32px; font-weight: 700; line-height: 1.2; margin-bottom: 16px; }
  .card-hero .card-summary { font-size: 17px; color: var(--text-muted); line-height: 1.6; margin-bottom: 20px; display: -webkit-box; -webkit-line-clamp: 3; line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
  .card-hero .thumb-wrap { flex: 1; aspect-ratio: 16/10; border-radius: 20px; overflow: hidden; border: 1px solid var(--border); }
  .card-hero.reverse { flex-direction: row-reverse; }

  /* GRID CARD */
  .card-grid .thumb-wrap { width: 100%; aspect-ratio: 16/10; border-radius: 12px; overflow: hidden; margin-bottom: 16px; border: 1px solid var(--border); }
  .card-grid .card-title { font-family: var(--font-serif); font-size: 18px; font-weight: 700; line-height: 1.4; margin-bottom: 12px; }
  .card-grid .card-summary { display: none; }

  .thumb { width:100%; height:100%; object-fit:cover; transition: transform 0.5s; }
  .card:hover .thumb { transform: scale(1.03); }

  /* META UI */
  .card-meta { display: flex; align-items: center; gap: 12px; color: var(--text-muted); font-size: 13px; font-weight: 600; }
  .source-icons { display: flex; -webkit-mask-image: linear-gradient(to right, black 80%, transparent 100%); mask-image: linear-gradient(to right, black 80%, transparent 100%); }
  .source-icons img { width: 18px; height: 18px; border-radius: 4px; border: 2px solid var(--bg); margin-left: -6px; }
  .source-icons img:first-child { margin-left: 0; }
  .card-actions { margin-left: auto; display: flex; gap: 16px; opacity: 0; transition: opacity 0.2s; }
  .card:hover .card-actions { opacity: 1; }
  .action-btn { background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 4px; font-size: 14px; }
  .action-btn:hover { color: var(--text); }

  /* IMMERSIVE QUICK VIEW (SIDE PANEL) */
  .quick-view { 
     padding: 0; border-left: 1px solid var(--border); overflow-y: auto; 
     background: var(--bg); position: sticky; top: 0; height: 100vh;
     transition: opacity 0.3s;
  }
  .qv-content { opacity: 1; } /* No animation for content updates */

  .qv-image-hero { 
     width: 100%; height: 240px; background: var(--hover-bg); overflow: hidden; position: relative;
     border-bottom: 1px solid var(--border);
  }
  .qv-image-hero img { width: 100%; height: 100%; object-fit: cover; }
  .qv-image-hero::after {
     content: ""; position: absolute; inset: 0; background: linear-gradient(to top, rgba(0,0,0,0.4), transparent);
  }

  .qv-body { padding: 32px; display: flex; flex-direction: column; gap: 24px; }
  .qv-label { font-size: 11px; font-weight: 900; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: -8px; }
  .qv-title { font-family: var(--font-serif); font-size: 24px; font-weight: 700; color: var(--text); line-height: 1.25; }
  .qv-summary { font-size: 16px; color: var(--text-muted); line-height: 1.7; white-space: pre-wrap; font-weight: 400; }
  .qv-sec-title { font-size: 13px; font-weight: 800; border-bottom: 1px solid var(--border); padding-bottom: 8px; margin-top: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
  
  .qv-footer { padding: 24px 32px; border-top: 1px solid var(--border); background: var(--bg); position: sticky; bottom: 0; }
  .btn-read-full { 
     display: flex; align-items: center; justify-content: center; gap: 10px; width: 100%; 
     padding: 12px; background: var(--accent); color: white; border: none; border-radius: 12px;
     font-weight: 700; font-size: 14px; text-decoration: none; transition: 0.2s;
  }
  .btn-read-full:hover { background: var(--accent-hover); transform: translateY(-2px); }
  .qv-empty { text-align: center; opacity: 0.5; padding: 100px 40px; font-size: 15px; }

  /* MOBILE RESPONSIVE */
  @media (max-width: 1100px) {
    .sidebar { transform: translateX(-100%); width: 280px; }
    .sidebar.open { transform: translateX(0); }
    .app-container { margin-left: 0; display: block; width: 100%; transition: none; }
    .sidebar-collapsed .app-container { width: 100%; }
    .quick-view { display: none; }
    .main-feed { padding: 16px; width: 100%; }
    .mobile-top-nav { display: flex; align-items: center; gap: 16px; padding: 12px 16px; position: sticky; top: 0; background: var(--bg); z-index: 101; border-bottom: 1px solid var(--border); }
    .discover-header { font-size: 28px; }
    #btnToggleSidebar, #btnToggleQV { display: none; }
    #newsList { gap: 32px; }
    .card-hero { flex-direction: column; gap: 16px; align-items: flex-start; }
    .card-hero .card-title { font-size: 22px; }
    .card-hero .thumb-wrap { width: 100%; }
    .card-row { display: flex; flex-direction: column; gap: 32px; }
    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 400; display: none; }
    .sidebar.open + .overlay { display: block; }
  }

  @media (min-width: 1101px) { .mobile-top-nav { display: none; } }
  .loading { display: flex; justify-content: center; padding: 60px; }
</style>
</head>
<body>

<div id="sidebarOverlay" class="overlay"></div>

<aside class="sidebar" id="sidebar">
  <a href="./" class="sidebar-logo"><img src="assets/images/icon.jpg" alt=""><span>AI News</span></a>
  <nav>
    <a href="#" class="side-btn active"><i class="fa-solid fa-compass"></i> Discover</a>
    <a href="#" class="side-btn"><i class="fa-solid fa-magnifying-glass"></i> Search</a>
    <a href="#" class="side-btn"><i class="fa-solid fa-chart-line"></i> Markets</a>
    <a href="v1/index.html" class="side-btn"><i class="fa-solid fa-clock-rotate-left"></i> Legacy v1</a>
  </nav>
  <div class="side-footer">
    <button class="theme-btn" id="btnTheme"><i class="fa-solid fa-moon"></i> <span>Appearance</span></button>
  </div>
</aside>

<div class="app-container">
  <div class="mobile-top-nav">
    <button class="btn-toggle" id="btnMenu"><i class="fa-solid fa-bars"></i></button>
    <div style="font-weight: 800; font-size: 18px; flex: 1;">Discover</div>
  </div>

  <main class="main-feed">
    <header>
      <div class="header-actions">
        <button class="btn-toggle" id="btnToggleSidebar" title="Toggle Sidebar"><i class="fa-solid fa-bars-staggered"></i></button>
        <div class="discover-header">Discover</div>
        <button class="btn-toggle" id="btnToggleQV" title="Toggle Quick View" style="margin-left: auto;"><i class="fa-solid fa-circle-info"></i></button>
      </div>
      <div class="nav-tabs">
        <div class="tab active" data-cat="all">All</div>
        <div class="tab" data-cat="tech">Tech</div>
        <div class="tab" data-cat="finance">Finance</div>
        <div class="tab" data-cat="science">Science</div>
        <div class="tab" data-cat="world">World</div>
      </div>
    </header>

    <div id="newsList"></div>
    <div id="loader" class="loading"><i class="fa-solid fa-circle-notch fa-spin" style="font-size: 26px; color: var(--accent)"></i></div>
  </main>

  <aside class="quick-view" id="qvPanel">
    <div class="qv-empty">Di chuột vào một tin để xem nội dung chi tiết…</div>
  </aside>
</div>

<script>
// ==================== STATE & CONFIG ====================
const state = {
  dates: [], loadedIdx: 0, allItems: [], viewItems: [], renderedCount: 0,
  isLoading: false, isFinished: false, selectedCat: 'all', symbols: new Set(), activeIdx: -1
};

const CONFIG = { BATCH: 20 };
const SKIP_SYMBOLS = new Set(['TIN','USD','THU','VND','CEO','THA','MTL','NET','TOP','HCM','TRA','HAI','LAI','THI','BIG','VUA','TAN']);
const SOURCE_LOGOS = { 'Vietstock': 'vietstock', 'Markettimes': 'markettimes', 'Người Quan Sát': 'nguoiquansat', 'VnExpress': 'vnexpress', 'VnEconomy': 'vneconomy', 'Tin Nhanh Chứng Khoán': 'tnck', 'Vietnam+': 'vietnamplus', 'VTV': 'vtv', 'Thanh Niên': 'thanhnien', 'Tuổi Trẻ': 'tuoitre' };

const newsList = document.getElementById('newsList');
const loader = document.getElementById('loader');
const qvPanel = document.getElementById('qvPanel');
const btnMenu = document.getElementById('btnMenu');
const btnToggleSidebar = document.getElementById('btnToggleSidebar');
const btnToggleQV = document.getElementById('btnToggleQV');
const sidebarOverlay = document.getElementById('sidebarOverlay');
const btnTheme = document.getElementById('btnTheme');

// ==================== HELPERS ====================
async function fetchJSON(url) { try { const r = await fetch(url, { cache: 'no-store' }); return r.ok ? await r.json() : null; } catch { return null; } }
function escapeHTML(s) { return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\"/g,'&quot;'); }
function dateLabel(ts) { return new Date(ts).toLocaleDateString('vi-VN', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }).toUpperCase(); }

function getRelativeTime(ts) {
  const diff = Date.now() - new Date(ts).getTime();
  const mins = Math.floor(diff / 60000);
  if (mins < 1) return 'vừa xong';
  if (mins < 60) return `${mins}m ago`;
  const hours = Math.floor(mins / 60);
  if (hours < 24) return `${hours}h ago`;
  return new Date(ts).toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
}

// ==================== ENGINE ====================
async function loadSymbols() {
  try {
    const res = await fetch('assets/symbols.csv');
    const csv = await res.text();
    state.symbols = new Set(csv.split('\n').slice(1).map(l => l.split(',')[0]?.trim().toUpperCase()).filter(Boolean));
  } catch {}
}

function findSymbols(it) {
  if (state.symbols.size === 0) return [];
  const text = (it.title + ' ' + (it.summary||'')).toUpperCase();
  const words = text.split(/[^A-Z0-9À-Ỹ]/u);
  const out = new Set();
  for (const w of words) {
    if (w.length >= 3 && state.symbols.has(w)) {
      if (SKIP_SYMBOLS.has(w) && !new RegExp(`\\b${w}:`, 'i').test(text)) continue;
      out.add(w);
    }
  }
  return [...out];
}

async function loadNextDate() {
  if (state.isLoading || state.loadedIdx >= state.dates.length) {
    if (state.loadedIdx >= state.dates.length) { state.isFinished = true; loader.style.display = 'none'; }
    return;
  }
  state.isLoading = true;
  const date = state.dates[state.loadedIdx++];
  const data = await fetchJSON(`news/${date}.json`);
  if (data) {
    const items = Object.values(data).sort((a,b) => new Date(b.published) - new Date(a.published));
    state.allItems.push(...items);
    applyFilters();
  }
  state.isLoading = false;
}

function applyFilters() {
  const cat = state.selectedCat;
  state.viewItems = state.allItems.filter(it => {
    if (cat === 'all') return true;
    const text = (it.title + ' ' + (it.summary || '')).toLowerCase();
    const map = { tech: ['apple', 'google', 'microsoft', 'ai ', 'công nghệ', 'chip', 'máy tính'], finance: ['chứng khoán', 'tài chính', 'vàng', 'lãi suất', 'bank', 'ngân hàng', 'usd'], science: ['khoa học', 'vũ trụ', 'y tế', 'nghiên cứu'], world: ['thế giới', 'mỹ', 'nga', 'nato', 'ukraine'] };
    return (map[cat] || []).some(k => text.includes(k));
  });
}

function renderCard(it, idx, type) {
  const logoSuffix = SOURCE_LOGOS[it.source] || 'unknown';
  const time = getRelativeTime(it.published);
  const isHero = type === 'hero';
  const tags = findSymbols(it).map(s => `<span class="tag">${s}</span>`).join('');
  
  const el = document.createElement('article');
  el.className = `card ${isHero ? 'card-hero' : 'card-grid'}`;
  if (isHero && Math.floor(idx / 4) % 2 === 1) el.classList.add('reverse');

  el.onmouseenter = () => {
    document.querySelectorAll('.card').forEach(c => c.classList.remove('active'));
    el.classList.add('active');
    state.activeIdx = idx;
    
	const tags = findSymbols(it).map(s => `<span class="tag">${s}</span>`).join('');
    qvPanel.innerHTML = `
      <div class="qv-content">
        ${it.image ? `<div class="qv-image-hero"><img src="${it.image}" alt=""></div>` : ''}
        <div class="qv-body">
          <div class="qv-label">Nội dung chi tiết</div>
          <h2 class="qv-title">${escapeHTML(it.title)}</h2>
          <div class="qv-sec-title">Tóm tắt trí tuệ nhân tạo</div>
          <div class="qv-summary">${escapeHTML(it.summary || 'Không có bản tóm tắt chi tiết cho tin này.')}</div>
          
          ${tags ? `<div class="qv-sec-title">Cổ phiếu liên quan</div><div style="display:flex; gap:8px; flex-wrap:wrap;">${tags}</div>` : ''}
          
          <div class="qv-sec-title">Thông tin nguồn</div>
          <div class="card-meta">
            <div class="source-icons"><img src="assets/images/${logoSuffix}.png" onerror="this.style.display='none'"></div>
            <span>${escapeHTML(it.source)} • ${time}</span>
          </div>
        </div>
        <div class="qv-footer">
          <a href="${it.link}" target="_blank" class="btn-read-full"><i class="fa-solid fa-arrow-up-right-from-square"></i> Đọc tin đầy đủ</a>
        </div>
      </div>
    `;
  };
  el.onclick = () => window.open(it.link, '_blank');

  el.innerHTML = `
    <div class="card-content">
      <div class="card-meta" style="margin-bottom: 12px;">
        <div class="source-icons"><img src="assets/images/${logoSuffix}.png" onerror="this.style.display='none'"></div>
        <span>${escapeHTML(it.source)} • ${time}</span>
      </div>
      <h3 class="card-title">${escapeHTML(it.title)}</h3>
      <p class="card-summary">${escapeHTML(it.summary || '')}</p>
      <div class="card-meta">
        ${tags ? `<div style="display:flex; gap:6px;">${tags}</div>` : `<span>Original source</span>`}
        <div class="card-actions">
           <button class="action-btn"><i class="fa-regular fa-heart"></i></button>
           <button class="action-btn"><i class="fa-solid fa-ellipsis"></i></button>
        </div>
      </div>
    </div>
    ${it.image ? `<div class="thumb-wrap"><img src="${it.image}" class="thumb" loading="lazy" onerror="this.parentElement.style.display='none'"></div>` : ''}
  `;
  return el;
}

function renderBatch() {
  try {
    const frag = document.createDocumentFragment();
    const pattern = ['hero', 'grid', 'grid', 'grid'];
    
    let i = state.renderedCount;
    const targetEnd = Math.min(i + CONFIG.BATCH, state.viewItems.length);

    while (i < targetEnd) {
      const it = state.viewItems[i];
      const type = pattern[i % pattern.length];
      const remaining = targetEnd - i;

      if (type === 'hero' || window.innerWidth <= 1100 || remaining < 3) {
        frag.appendChild(renderCard(it, i, 'hero'));
        i++;
      } else {
        const row = document.createElement('div');
        row.className = 'card-row';
        for (let j = 0; j < 3 && i < targetEnd; j++, i++) {
          row.appendChild(renderCard(state.viewItems[i], i, 'grid'));
        }
        frag.appendChild(row);
      }
    }

    newsList.appendChild(frag);
    state.renderedCount = i;
    if (state.renderedCount >= state.viewItems.length && !state.isFinished) {
      loadNextDate().then(() => { if (state.renderedCount < state.viewItems.length) renderBatch(); });
    }
  } catch (e) {
    console.error("Render error:", e);
    loader.style.display = 'none';
  }
}

// ==================== EVENTS ====================
document.querySelectorAll('.tab').forEach(t => {
  t.onclick = () => {
    document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
    t.classList.add('active');
    state.selectedCat = t.dataset.cat;
    state.renderedCount = 0; newsList.innerHTML = ''; applyFilters(); renderBatch();
  };
});

const sidebar = document.getElementById('sidebar');

btnToggleSidebar.onclick = () => {
  document.body.classList.toggle('sidebar-collapsed');
  localStorage.setItem('sidebar-collapsed', document.body.classList.contains('sidebar-collapsed'));
};

btnToggleQV.onclick = () => {
  document.body.classList.toggle('qv-collapsed');
  localStorage.setItem('qv-collapsed', document.body.classList.contains('qv-collapsed'));
};

const toggleSidebar = (on) => {
  sidebar.classList.toggle('open', on);
  sidebarOverlay.style.display = on ? 'block' : 'none';
};
btnMenu.onclick = (e) => { e.stopPropagation(); toggleSidebar(true); };
sidebarOverlay.onclick = () => toggleSidebar(false);

btnTheme.onclick = () => {
  const next = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
  document.documentElement.setAttribute('data-theme', next);
  localStorage.setItem('theme', next);
  btnTheme.innerHTML = `<i class="fa-solid fa-${next === 'dark' ? 'moon' : 'sun'}"></i> Appearance`;
};

// ==================== BOOT ====================
async function boot() {
  const theme = localStorage.getItem('theme') || 'dark';
  document.documentElement.setAttribute('data-theme', theme);
  btnTheme.innerHTML = `<i class="fa-solid fa-${theme === 'dark' ? 'moon' : 'sun'}"></i> Appearance`;
  if (localStorage.getItem('sidebar-collapsed') === 'true') document.body.classList.add('sidebar-collapsed');
  if (localStorage.getItem('qv-collapsed') === 'true') document.body.classList.add('qv-collapsed');

  await loadSymbols();
  const idx = await fetchJSON('news/index.json');
  if (idx) { state.dates = idx.dates || []; await loadNextDate(); renderBatch(); }
  
  const ob = new IntersectionObserver(es => { if (es[0].isIntersecting && !state.isLoading) renderBatch(); }, { rootMargin: '800px' });
  ob.observe(loader);
}
boot();
</script>
</body>
</html>
